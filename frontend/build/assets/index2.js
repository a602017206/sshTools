function ve(y,t){for(var v=0;v<t.length;v++){const f=t[v];if(typeof f!="string"&&!Array.isArray(f)){for(const m in f)if(m!=="default"&&!(m in y)){const _=Object.getOwnPropertyDescriptor(f,m);_&&Object.defineProperty(y,m,_.get?_:{enumerable:!0,get:()=>f[m]})}}}return Object.freeze(Object.defineProperty(y,Symbol.toStringTag,{value:"Module"}))}function Ee(y){return y&&y.__esModule&&Object.prototype.hasOwnProperty.call(y,"default")?y.default:y}var J={exports:{}},$={exports:{}},ee={exports:{}};(function(y){var t=y.exports;const v=24,f=17,m=19,_=128|f,r=128|m,n=24;t.ZMLIB={ZDLE:v,XON:f,XOFF:m,ABORT_SEQUENCE:[n,n,n,n,n],strip_ignored_bytes:function(h){for(var E=h.length-1;E>=0;E--)switch(h[E]){case f:case _:case m:case r:h.splice(E,1);continue}return h},find_subarray:function(h,E){var x=0,l;e:for(;x!==-1;){if(x=h.indexOf(E[0],x),x===-1)break e;for(l=1;l<E.length;l++)if(h[x+l]!==E[l]){x++;continue e}return x}return-1}}})(ee);var P=ee.exports,te={exports:{}},re={exports:{}};(function(y){var t=y.exports;const v=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102],f={};for(var m=0;m<v.length;m++)f[v[m]]=m;t.ENCODELIB={pack_u16_be:function(r){if(r>65535)throw"Number cannot exceed 16 bits: "+r;return[r>>8,r&255]},pack_u32_le:function(r){var n=r/65536;return[r&255,(r&65535)>>8,n&255,n>>8]},unpack_u16_be:function(r){return(r[0]<<8)+r[1]},unpack_u32_le:function(r){return r[0]+(r[1]<<8)+(r[2]<<16)+r[3]*16777216},octets_to_hex:function(r){for(var n=[],a=0;a<r.length;a++)n.push(v[r[a]>>4],v[r[a]&15]);return n},parse_hex_octets:function(r){for(var n=new Array(r.length/2),a=0;a<n.length;a++)n[a]=(f[r[2*a]]<<4)+f[r[1+2*a]];return n}}})(re);var U=re.exports,ne={exports:{}};(function(y){class t{encode(_){_=unescape(encodeURIComponent(_));for(var r=new Array(_.length),n=0;n<_.length;n++)r[n]=_.charCodeAt(n);return new Uint8Array(r)}}class v{decode(_){return decodeURIComponent(escape(String.fromCharCode.apply(String,_)))}}var f=y.exports;f.Text={Encoder:typeof TextEncoder<"u"?TextEncoder:t,Decoder:typeof TextDecoder<"u"?TextDecoder:v}})(ne);var be=ne.exports,se={exports:{}};(function(y){var t=y.exports;Object.assign(t,P);var v,f;const m=t.ZMLIB.ZDLE;t.ZDLE=class _e{constructor(r){this._config={},r&&this.set_escape_ctrl_chars(!!r.escape_ctrl_chars)}set_escape_ctrl_chars(r){if(typeof r!="boolean")throw"need boolean!";r!==this._config.escape_ctrl_chars&&(this._config.escape_ctrl_chars=r,this._setup_zdle_table())}escapes_ctrl_chars(){return!!this._config.escape_ctrl_chars}encode(r){if(!this._zdle_table)throw"No ZDLE encode table configured!";var n=this._zdle_table,a=this._lastcode,h=new ArrayBuffer(2*r.length),E=new Uint8Array(h),x=this._config.escape_ctrl_chars,l=0;for(v=0;v<r.length;v++){if(f=n[r[v]],!f)throw console.trace(),console.error("bad encode() call:",JSON.stringify(r)),this._lastcode=a,"Invalid octet: "+r[v];a=r[v],f===1||(x||f===2||(a&127)===64)&&(E[l]=m,l++,a^=64),E[l]=a,l++}return this._lastcode=a,r.splice(0),r.push.apply(r,new Uint8Array(h,0,l)),r}static decode(r){for(var n=r.length-1;n>=0;n--)r[n]===m&&r.splice(n,2,r[n+1]-64);return r}static splice(r,n,a){var h=0;n||(n=0);for(var E=n;E<r.length&&h<a;E++)h++,r[E]===m&&E++;if(h===a)return r.length===E-1?void 0:(r.splice(0,n),_e.decode(r.splice(0,E-n)))}_setup_zdle_table(){for(var r=new Array(256),n=0;n<r.length;n++)if(n&96)r[n]=1;else switch(n){case m:case t.ZMLIB.XOFF:case t.ZMLIB.XON:case t.ZMLIB.XOFF|128:case t.ZMLIB.XON|128:r[n]=2;break;case 16:case 144:r[n]=this._config.turbo_escape?1:2;break;case 13:case 141:r[n]=this._config.escape_ctrl_chars?2:this._config.turbo_escape?1:3;break;default:r[n]=this._config.escape_ctrl_chars?2:1}this._zdle_table=r}}})(se);var X=se.exports,ie={exports:{}},ae={exports:{}},oe={};/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */(function(y){(function(t){t(typeof DO_NOT_EXPORT_CRC>"u"?y:{})})(function(t){t.version="1.2.2";function v(){for(var c=0,k=new Array(256),d=0;d!=256;++d)c=d,c=c&1?-306674912^c>>>1:c>>>1,c=c&1?-306674912^c>>>1:c>>>1,c=c&1?-306674912^c>>>1:c>>>1,c=c&1?-306674912^c>>>1:c>>>1,c=c&1?-306674912^c>>>1:c>>>1,c=c&1?-306674912^c>>>1:c>>>1,c=c&1?-306674912^c>>>1:c>>>1,c=c&1?-306674912^c>>>1:c>>>1,k[d]=c;return typeof Int32Array<"u"?new Int32Array(k):k}var f=v();function m(c){var k=0,d=0,I=0,O=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(I=0;I!=256;++I)O[I]=c[I];for(I=0;I!=256;++I)for(d=c[I],k=256+I;k<4096;k+=256)d=O[k]=d>>>8^c[d&255];var C=[];for(I=1;I!=16;++I)C[I-1]=typeof Int32Array<"u"?O.subarray(I*256,I*256+256):O.slice(I*256,I*256+256);return C}var _=m(f),r=_[0],n=_[1],a=_[2],h=_[3],E=_[4],x=_[5],l=_[6],N=_[7],b=_[8],A=_[9],e=_[10],s=_[11],o=_[12],p=_[13],R=_[14];function T(c,k){for(var d=k^-1,I=0,O=c.length;I<O;)d=d>>>8^f[(d^c.charCodeAt(I++))&255];return~d}function S(c,k){for(var d=k^-1,I=c.length-15,O=0;O<I;)d=R[c[O++]^d&255]^p[c[O++]^d>>8&255]^o[c[O++]^d>>16&255]^s[c[O++]^d>>>24]^e[c[O++]]^A[c[O++]]^b[c[O++]]^N[c[O++]]^l[c[O++]]^x[c[O++]]^E[c[O++]]^h[c[O++]]^a[c[O++]]^n[c[O++]]^r[c[O++]]^f[c[O++]];for(I+=15;O<I;)d=d>>>8^f[(d^c[O++])&255];return~d}function D(c,k){for(var d=k^-1,I=0,O=c.length,C=0,H=0;I<O;)C=c.charCodeAt(I++),C<128?d=d>>>8^f[(d^C)&255]:C<2048?(d=d>>>8^f[(d^(192|C>>6&31))&255],d=d>>>8^f[(d^(128|C&63))&255]):C>=55296&&C<57344?(C=(C&1023)+64,H=c.charCodeAt(I++)&1023,d=d>>>8^f[(d^(240|C>>8&7))&255],d=d>>>8^f[(d^(128|C>>2&63))&255],d=d>>>8^f[(d^(128|H>>6&15|(C&3)<<4))&255],d=d>>>8^f[(d^(128|H&63))&255]):(d=d>>>8^f[(d^(224|C>>12&15))&255],d=d>>>8^f[(d^(128|C>>6&63))&255],d=d>>>8^f[(d^(128|C&63))&255]);return~d}t.table=f,t.bstr=T,t.buf=S,t.str=D})})(oe);var ce={exports:{}};(function(y){var t=y.exports;function v(r,n){return this.got=r.slice(0),this.expected=n.slice(0),"CRC check failed! (got: "+r.join()+"; expected: "+n.join()+")"}function f(r){return r}const m={aborted:"Session aborted",peer_aborted:"Peer aborted session",already_aborted:"Session already aborted",crc:v,validation:f};function _(r){const n=m[r];switch(typeof n){case"string":return n;case"function":var a=[].slice.call(arguments).slice(1);return n.apply(this,a)}return null}t.Error=class extends Error{constructor(n){super();var a=_.apply(this,arguments);a?(this.type=n,this.message=a):this.message=n}}})(ce);var z=ce.exports;(function(y){const t=oe;var v=y.exports;Object.assign(v,z,U);var f;const m=16,_=4129,r=65535,n=1<<m-1;function a(){f=new Array(256);for(var x=m-8,l=0;l<256;l++){for(var N=l<<x&r,b=0;b<8;b++)N&n?(N<<=1,N^=_):N<<=1;f[l]=N&r}}function h(x,l){return f||a(),f[l>>8&255]^(255&l)<<8^x}function E(x,l){if(x.join()!==l.join())throw new v.Error("crc",l,x)}v.CRC={crc16:function(l){for(var N=l[0],b=1;b<l.length;b++)N=h(l[b],N);return N=h(0,h(0,N)),v.ENCODELIB.pack_u16_be(N)},crc32:function(l){return v.ENCODELIB.pack_u32_le(t.buf(l)>>>0)},verify16:function(l,N){return E(this.crc16(l),N)},verify32:function(l,N){try{E(this.crc32(l),N)}catch(b){throw b.input=l.slice(0),b}}}})(ae);var de=ae.exports;(function(y){var t=y.exports;Object.assign(t,U,X,P,de,z);const v=42,f=65,m=66,_=67,r=[13,10],n=r.slice(0).concat([t.ZMLIB.XON]),a=[v,v,t.ZMLIB.ZDLE,m],h=[v,t.ZMLIB.ZDLE,f],E=[v,t.ZMLIB.ZDLE,_];t.Header=class{static trim_leading_garbage(i){var u=[],Z,w;e:for(;i.length&&!w;){var L=i.indexOf(v);if(L===-1){Z=!0;break e}else{if(u.push.apply(u,i.splice(0,L)),i.length<2)break e;if(i[1]===v)if(i.length<a.length){if(i.join()===a.slice(0,i.length).join())break e}else i[2]===a[2]&&i[3]===a[3]&&(w=j);else if(i[1]===t.ZMLIB.ZDLE){if(i.length<h.length)break e;i[2]===h[2]?w=Y:i[2]===E[2]&&(w=W)}w||u.push(i.shift())}}return Z&&u.push.apply(u,i.splice(0)),u}static parse(i){var u;if(i[1]===v)return u=j(i),u&&[u,16];if(i[2]===f)return u=Y(i),u&&[u,16];if(i[2]===_)return u=W(i),u&&[u,32];if(!(i.length<3))throw"Unrecognized/unsupported octets: "+i.join()}static build(i){var u=arguments.length===1?[arguments[0]]:Array.apply(null,arguments),Z=V[i];if(!Z)throw"No frame class “"+i+"” is defined!";u.shift();var w=new(Z.bind.apply(Z,[null].concat(u)));return w}to_hex(){var i=this._crc_bytes();return a.concat(t.ENCODELIB.octets_to_hex(i.concat(t.CRC.crc16(i))),this._hex_header_ending)}to_binary16(i){return this._to_binary(i,h,t.CRC.crc16)}to_binary32(i){return this._to_binary(i,E,t.CRC.crc32)}constructor(){this._bytes4||(this._bytes4=[0,0,0,0])}_to_binary(i,u,Z){var w=this._crc_bytes(),L=u.concat(i.encode(w.concat(Z(w))));return L}_crc_bytes(){return[this.TYPENUM].concat(this._bytes4)}},t.Header.prototype._hex_header_ending=n;class x extends t.Header{}const l={CANFDX:1,CANOVIO:2,CANBRK:4,CANCRY:8,CANLZW:16,CANFC32:32,ESCCTL:64,ESC8:128};function N(g){if(!l[g])throw new t.Error("Invalid ZRINIT flag: "+g);return l[g]}class b extends t.Header{constructor(i,u){super();var Z=0;u||(u=0),i.forEach(function(w){Z|=N(w)}),this._bytes4=[u&255,u>>8,0,Z]}get_buffer_size(){return t.ENCODELIB.unpack_u16_be(this._bytes4.slice(0,2))||void 0}can_full_duplex(){return!!(this._bytes4[3]&l.CANFDX)}can_overlap_io(){return!!(this._bytes4[3]&l.CANOVIO)}can_break(){return!!(this._bytes4[3]&l.CANBRK)}can_fcs_32(){return!!(this._bytes4[3]&l.CANFC32)}escape_ctrl_chars(){return!!(this._bytes4[3]&l.ESCCTL)}escape_8th_bit(){return!!(this._bytes4[3]&l.ESC8)}}const A={ESCCTL:64,ESC8:128};function e(g){if(!A[g])throw"Invalid ZSINIT flag: "+g;return A[g]}class s extends t.Header{constructor(i,u){super();var Z=0;if(i.forEach(function(w){Z|=e(w)}),this._bytes4=[0,0,0,Z],u){if(u.length>31)throw"Attn sequence must be <= 31 bytes";if(u.some(function(w){return w>255}))throw"Attn sequence ("+u+") must be <256";this._data=u.concat([0])}}escape_ctrl_chars(){return!!(this._bytes4[3]&A.ESCCTL)}escape_8th_bit(){return!!(this._bytes4[3]&A.ESC8)}}class o extends t.Header{constructor(i){super(),i&&(this._bytes4=i.slice())}}o.prototype._hex_header_ending=r;const p={extended:{sparse:64},transport:[void 0,"compress","encrypt","rle"],management:[void 0,"newer_or_longer","crc","append","clobber","newer","mtime_or_length","protect","rename"],conversion:[void 0,"binary","text","resume"]},R=["extended","transport","management","conversion"],T=128,S=31,D=64;class c extends t.Header{get_options(){var i={sparse:!!(this._bytes4[0]&D)},u=this._bytes4.slice(0);return R.forEach(function(Z,w){if(p[Z]instanceof Array)Z==="management"&&(i.skip_if_absent=!!(u[w]&T),u[w]&=S),i[Z]=p[Z][u[w]];else for(var L in p[Z])i[L]=!!(u[w]&p[Z][L]),i[L]&&(u[w]^=p[Z][L]);!i[Z]&&u[w]&&(i[Z]="unknown:"+u[w])}),i}}class k extends t.Header{}class d extends t.Header{}class I extends t.Header{}class O extends t.Header{}I.prototype._hex_header_ending=r;class C extends t.Header{constructor(i){super(),this._bytes4=t.ENCODELIB.pack_u32_le(i)}get_offset(){return t.ENCODELIB.unpack_u32_le(this._bytes4)}}class H extends C{}class K extends C{}class G extends C{}const M=[[x,"ZRQINIT"],[b,"ZRINIT"],[s,"ZSINIT"],[o,"ZACK"],[c,"ZFILE"],[k,"ZSKIP"],void 0,[d,"ZABORT"],[I,"ZFIN"],[H,"ZRPOS"],[K,"ZDATA"],[G,"ZEOF"],[O,"ZFERR"],void 0,void 0,void 0,void 0,void 0,void 0,void 0];for(var V={},F=0;F<M.length;F++)M[F]&&(V[M[F][1]]=M[F][0],Object.assign(M[F][0].prototype,{TYPENUM:F,NAME:M[F][1]}));const ue=[x,b,s,o,c,k,"ZNAK",d,I,H,K,G,O,"ZCRC","ZCHALLENGE","ZCOMPL","ZCAN","ZFREECNT","ZCOMMAND","ZSTDERR"];function q(g){var i=ue[g];if(typeof i=="string")throw"Received unsupported header: "+i;return pe(i)}function pe(g){return g.prototype instanceof C?new g(0):new g([])}function Y(g){var i=t.ZDLE.splice(g,h.length,7);return i&&Q(i)}function Q(g){t.CRC.verify16(g.slice(0,5),g.slice(5));var i=g[0],u=q(i);return u._bytes4=g.slice(1,5),u}function W(g){var i=t.ZDLE.splice(g,E.length,9);if(i){t.CRC.verify32(i.slice(0,5),i.slice(5));var u=i[0],Z=q(u);return Z._bytes4=i.slice(1,5),Z}}function j(g){var i=g.indexOf(138);i===-1&&(i=g.indexOf(10));var u,Z;if(i===-1){g.length>11&&(u="Invalid hex header - no LF detected within 12 bytes!");return}else if(Z=g.splice(0,i),g.shift(),Z.length===19){var w=Z.pop();w!==13&&w!==141&&(u="Invalid hex header: (CR/)LF doesn’t have CR!")}else Z.length!==18&&(u="Invalid hex header: invalid number of bytes before LF!");if(u)throw u+=" ("+Z.length+" bytes: "+Z.join()+")",u;Z.splice(0,4);var L=t.ENCODELIB.parse_hex_octets(Z);return Q(L)}t.Header.parse_hex=j})(ie);var me=ie.exports,he={exports:{}};(function(y){var t=y.exports;Object.assign(t,de,X,P,z);const v=104,f=105,m=106,_=107;var r;t.Subpacket=class B{static build(b,A){var e=r[A];if(!e)throw"No subpacket type “"+A+"” is defined! Try one of: "+Object.keys(r).join(", ");return new e(b)}encode16(b){return this._encode(b,t.CRC.crc16)}encode32(b){return this._encode(b,t.CRC.crc32)}get_payload(){return this._payload}static parse16(b){return B._parse(b,2)}static parse32(b){return B._parse(b,4)}constructor(b){this._payload=b}_encode(b,A){return b.encode(this._payload.slice(0)).concat([t.ZMLIB.ZDLE,this._frameend_num],b.encode(A(this._payload.concat(this._frameend_num))))}static _parse(b,A){for(var e,s,o={104:h,105:x,106:l,107:E},p=0;p<b.length;){if(p=b.indexOf(t.ZMLIB.ZDLE,p),p===-1)return;var R=b[p+1];if(s=o[R],s){e=p+1;break}p++}if(s){var T=b[e];if(b[e-1]!==t.ZMLIB.ZDLE)throw"Byte before frame end should be ZDLE, not "+b[e-1];var S=b.splice(0,e-1),D=t.ZDLE.splice(b,2,A);if(!D){b.unshift.apply(b,S);return}var c=t.ZDLE.decode(S);return t.CRC[A===2?"verify16":"verify32"](c.concat([T]),D),new s(c,D)}}};class n extends t.Subpacket{frame_end(){return!0}}class a extends t.Subpacket{frame_end(){return!1}}class h extends n{ack_expected(){return!1}}h.prototype._frameend_num=v;class E extends n{ack_expected(){return!0}}E.prototype._frameend_num=_;class x extends a{ack_expected(){return!1}}x.prototype._frameend_num=f;class l extends a{ack_expected(){return!0}}l.prototype._frameend_num=m,r={end_no_ack:h,end_ack:E,no_end_no_ack:x,no_end_ack:l}})(he);var ge=he.exports,fe={exports:{}};(function(y){var t=y.exports;Object.assign(t,z);const v=/\*\x18[AC]|\*\*\x18B/;function f(m,_){if(_<0)throw new t.Error("validation","“"+m+"” ("+_+") must be nonnegative.");if(_!==Math.floor(_))throw new t.Error("validation","“"+m+"” ("+_+") must be an integer.")}t.Validation={offer_parameters:function(_){if(!_.name)throw new t.Error("validation","Need “name”!");if(typeof _.name!="string")throw new t.Error("validation","“name” ("+_.name+") must be a string!");if(_=Object.assign({},_),v.test(_.name)&&console.warn("The filename "+JSON.stringify(name)+" contains characters that look like a ZMODEM header. This could corrupt the ZMODEM session; consider renaming it so that the filename doesn’t contain control characters."),_.serial!==null&&_.serial!==void 0)throw new t.Error("validation","“serial” is meaningless.");if(_.serial=null,["size","mode","files_remaining","bytes_remaining"].forEach(function(a){var h;switch(typeof _[a]){case"object":h=_[a]===null;break;case"undefined":_[a]=null,h=!0;break;case"number":f(a,_[a]),h=!0;break}if(!h)throw new t.Error("validation","“"+a+"” ("+_[a]+") must be null, undefined, or a number.")}),typeof _.mode=="number"&&(_.mode|=32768),_.files_remaining===0)throw new t.Error("validation","“files_remaining”, if given, must be positive.");var r;switch(typeof _.mtime){case"object":if(r=!0,_.mtime instanceof Date){var n=_.mtime;if(_.mtime=Math.floor(n.getTime()/1e3),_.mtime<0)throw new t.Error("validation","“mtime” ("+n+") must not be earlier than 1970.")}else _.mtime!==null&&(r=!1);break;case"undefined":_.mtime=null,r=!0;break;case"number":f("mtime",_.mtime),r=!0;break}if(!r)throw new t.Error("validation","“mtime” ("+_.mtime+") must be null, undefined, a Date, or a number.");return _}}})(fe);var xe=fe.exports;(function(y){var t=y.exports;t.DEBUG=!1,Object.assign(t,U,be,X,P,me,ge,xe,z);const v=5e3,f=["CANFDX","CANOVIO","CANFC32"],m="spool_uint8array",_=8192,r=8,n=[79,79],a=t.ZMLIB.ABORT_SEQUENCE;class h{constructor(){this._on_evt={},this._evt_once_index={}}_Add_event(e){this._on_evt[e]=[],this._evt_once_index[e]=[]}_get_evt_queue(e){if(!this._on_evt[e])throw"Bad event: "+e;return this._on_evt[e]}on(e,s){var o=this._get_evt_queue(e);return o.push(s),this}off(e,s){var o=this._get_evt_queue(e);if(s){var p=o.indexOf(s);if(p===-1)throw"“"+s+"” is not in the “"+e+"” queue.";o.splice(p,1)}else o.pop();return this}_Happen(e){var s=this._get_evt_queue(e),o=Array.apply(null,arguments);o.shift();var p=this;return s.forEach(function(R){R.apply(p,o)}),s.length}}t.Session=class extends h{static parse(e){var s;try{s=t.Header.parse_hex(e)}catch{return}if(s)switch(s.NAME){case"ZRQINIT":return new t.Session.Receive;case"ZRINIT":return new t.Session.Send(s)}}set_sender(e){return this._sender=e,this}has_ended(){return this._has_ended()}consume(e){if(this._before_consume(e),this._aborted)throw new t.Error("already_aborted");e.length&&(this._strip_and_enqueue_input(e),this._check_for_abort_sequence(e)||this._consume_first())}aborted(){return!!this._aborted}constructor(){super(),this._config={},this._input_buffer=[],this._Add_event("receive"),this._Add_event("garbage"),this._Add_event("session_end")}get_role(){return this.type}_trim_leading_garbage_until_header(){var e=t.Header.trim_leading_garbage(this._input_buffer);e.length&&this._Happen("garbage",e)===0&&console.debug("Garbage: ",String.fromCharCode.apply(String,e),e)}_parse_and_consume_header(){this._trim_leading_garbage_until_header();var e=t.Header.parse(this._input_buffer);if(e)return t.DEBUG&&this._log_header("RECEIVED HEADER",e[0]),this._consume_header(e[0]),this._last_header_name=e[0].NAME,this._last_header_crc=e[1],e[0]}_log_header(e,s){console.debug(this.type,e,s.NAME,s._bytes4.join())}_consume_header(e){this._on_receive(e);var s=this._next_header_handler&&this._next_header_handler[e.NAME];if(!s)throw console.error("Unhandled header!",e,this._next_header_handler),new t.Error("Unhandled header: "+e.NAME);this._next_header_handler=null,s.call(this,e)}_check_for_abort_sequence(){var e=t.ZMLIB.find_subarray(this._input_buffer,a);if(e!==-1)throw this._input_buffer.splice(0,e+a.length),this._aborted=!0,this._on_session_end(),new t.Error("peer_aborted")}_send_header(e){if(!this._sender)throw"Need sender!";var s=Array.apply(null,arguments),o=this._create_header_bytes(s);t.DEBUG&&this._log_header("SENDING HEADER",o[1]),this._sender(o[0]),this._last_sent_header=o[1]}_create_header_bytes(e){var s=t.Header.build.apply(t.Header,e),o=this._get_header_formatter(e[0]);return[s[o](this._zencoder),s]}_strip_and_enqueue_input(e){t.ZMLIB.strip_ignored_bytes(e),this._input_buffer.push.apply(this._input_buffer,e)}abort(){this._sender(a.concat([r,r,r,r,r])),this._aborted=!0,this._sender=function(){throw new t.Error("already_aborted")},this._on_session_end()}_on_session_end(){this._Happen("session_end")}_on_receive(e){this._Happen("receive",e)}_before_consume(){}};function E(A){return t.ZMLIB.find_subarray(A,n)===0?A.splice(0,n.length):A[0]===n[n.length-1]&&A.splice(0,1),A}t.Session.Receive=class extends t.Session{constructor(){super(),this._Add_event("offer"),this._Add_event("data_in"),this._Add_event("file_end")}_before_consume(e){if(this._bytes_after_OO)throw"PROTOCOL: Session is completed!";this._bytes_being_consumed=e}get_trailing_bytes(){if(this._aborted)return[];if(!this._bytes_after_OO)throw"PROTOCOL: Session is not completed!";return this._bytes_after_OO.slice(0)}_has_ended(){return this.aborted()||!!this._bytes_after_OO}_get_header_formatter(){return"to_hex"}_parse_and_consume_subpacket(){var e;this._last_header_crc===16?e="parse16":e="parse32";var s=t.Subpacket[e](this._input_buffer);return s&&(t.DEBUG&&console.debug(this.type,"RECEIVED SUBPACKET",s),this._consume_data(s),s.frame_end()&&(this._next_subpacket_handler=null)),s}_consume_first(){if(this._got_ZFIN){if(this._input_buffer.length<2)return;if(t.ZMLIB.find_subarray(this._input_buffer,n)===0){this._bytes_after_OO=E(this._bytes_being_consumed.slice(0)),this._on_session_end();return}else throw"PROTOCOL: Only thing after ZFIN should be “OO” (79,79), not: "+this._input_buffer.join()}var e;do this._next_subpacket_handler?e=this._parse_and_consume_subpacket():e=this._parse_and_consume_header();while(e&&this._input_buffer.length)}_consume_data(e){if(this._on_receive(e),!this._next_subpacket_handler)throw"PROTOCOL: Received unexpected data packet after "+this._last_header_name+" header: "+e.get_payload().join();this._next_subpacket_handler.call(this,e)}_octets_to_string(e){return this._textdecoder||(this._textdecoder=new t.Text.Decoder),this._textdecoder.decode(new Uint8Array(e))}_consume_ZFILE_data(e,s){if(this._file_info)throw"PROTOCOL: second ZFILE data subpacket received";var o=s.get_payload(),p=o.indexOf(0),R=this._octets_to_string(o.slice(0,p)),T=this._octets_to_string(o.slice(1+p)).split(" "),S=T[1]&&parseInt(T[1],8)||void 0;S&&(S=new Date(S*1e3)),this._file_info={name:R,size:T[0]?parseInt(T[0],10):null,mtime:S||null,mode:T[2]&&parseInt(T[2],8)||null,serial:T[3]&&parseInt(T[3],10)||null,files_remaining:T[4]?parseInt(T[4],10):null,bytes_remaining:T[5]?parseInt(T[5],10):null};var D=new N(e.get_options(),this._file_info,this._accept.bind(this),this._skip.bind(this));this._current_transfer=D}_consume_ZDATA_data(e){if(!this._accepted_offer)throw"PROTOCOL: Received data without accepting!";if(!this._offset_ok){console.warn("offset not ok!"),_send_ZRPOS();return}this._file_offset+=e.get_payload().length,this._on_data_in(e),e.ack_expected()&&!e.frame_end()&&this._send_header("ZACK",t.ENCODELIB.pack_u32_le(this._file_offset))}_make_promise_for_between_files(){var e=this;return new Promise(function(s){var o={ZFILE:function(p){this._next_subpacket_handler=function(R){this._next_subpacket_handler=null,this._consume_ZFILE_data(p,R),this._Happen("offer",this._current_transfer),s(this._current_transfer)}},ZSINIT:function(p){e._next_subpacket_handler=function(R){e._next_subpacket_handler=null,e._consume_ZSINIT_data(R),e._send_header("ZACK"),e._next_header_handler=o}},ZFIN:function(){this._consume_ZFIN(),s()}};e._next_header_handler=o})}_consume_ZSINIT_data(e){this._attn=e.get_payload()}start(){if(this._started)throw"Already started!";this._started=!0;var e=this._make_promise_for_between_files();return this._send_ZRINIT(),e}_accept(e){this._accepted_offer=!0,this._file_offset=e||0;var s=this,o=new Promise(function(p){s._next_header_handler={ZDATA:function(T){this._consume_ZDATA(T),this._next_subpacket_handler=this._consume_ZDATA_data,this._next_header_handler={ZEOF:function(D){this._consume_ZEOF(D),this._next_subpacket_handler=null,this._make_promise_for_between_files(),p(),this._send_ZRINIT()}}}}});return this._send_ZRPOS(),o}_skip(){var e=this._make_promise_for_between_files();if(this._accepted_offer){if(!this._current_transfer)return;var s=(function(){this._accepted_offer=!1,this._next_subpacket_handler=null,this._make_promise_for_between_files()}).bind(this);Object.assign(this._next_header_handler,{ZEOF:s,ZDATA:(function(){s(),this._next_header_handler.ZEOF=s}).bind(this)})}return this._file_info=null,this._send_header("ZSKIP"),e}_send_ZRINIT(){this._send_header("ZRINIT",f)}_consume_ZFIN(){this._got_ZFIN=!0,this._send_header("ZFIN")}_consume_ZEOF(e){if(this._file_offset!==e.get_offset())throw"ZEOF offset mismatch; unimplemented (local: "+this._file_offset+"; ZEOF: "+e.get_offset()+")";this._on_file_end(),this._file_info=null,this._current_transfer=null}_consume_ZDATA(e){if(this._file_offset===e.get_offset())this._offset_ok=!0;else throw"Error correction is unimplemented."}_send_ZRPOS(){this._send_header("ZRPOS",this._file_offset)}_on_file_end(){this._Happen("file_end"),this._current_transfer&&(this._current_transfer._Happen("complete"),this._current_transfer=null)}_on_data_in(e){this._Happen("data_in",e),this._current_transfer&&this._current_transfer._Happen("input",e.get_payload())}},Object.assign(t.Session.Receive.prototype,{type:"receive"});var x={get_details:function(){return Object.assign({},this._file_info)},get_options:function(){return Object.assign({},this._zfile_opts)},get_offset:function(){return this._file_offset}};class l{constructor(e,s,o,p){this._file_info=e,this._file_offset=s||0,this._send=o,this._end=p}send(e){this._send(e),this._file_offset+=e.length}end(e){var s=this._end(e||[]);return e&&(this._file_offset+=e.length),s}}Object.assign(l.prototype,x);class N extends h{constructor(e,s,o,p){super(),this._zfile_opts=e,this._file_info=s,this._accept_func=o,this._skip_func=p,this._Add_event("input"),this._Add_event("complete"),this.on("input",this._input_handler)}_verify_not_skipped(){if(this._skipped)throw new t.Error("Already skipped!")}skip(){return this._verify_not_skipped(),this._skipped=!0,this._skip_func.apply(this,arguments)}accept(e){if(this._verify_not_skipped(),this._accepted)throw new t.Error("Already accepted!");switch(this._accepted=!0,e||(e={}),this._file_offset=e.offset||0,e.on_input){case null:case void 0:case"spool_array":case m:this._spool=[];break;default:if(typeof e.on_input!="function")throw"Invalid “on_input”: "+e.on_input}return this._input_handler_mode=e.on_input||m,this._accept_func(this._file_offset).then(this._get_spool.bind(this))}_input_handler(e){if(this._file_offset+=e.length,typeof this._input_handler_mode=="function")this._input_handler_mode(e);else{if(this._input_handler_mode===m)e=new Uint8Array(e);else if(this._input_handler_mode!=="spool_array")throw new t.Error("WTF?? _input_handler_mode = "+this._input_handler_mode);this._spool.push(e)}}_get_spool(){return this._spool}}Object.assign(N.prototype,x);const b={ZFILE:!0,ZDATA:!0};t.Session.Send=class extends t.Session{constructor(e){if(super(),e){if(e.NAME!=="ZRINIT")throw"First header should be ZRINIT, not "+e.NAME}else throw"Need first header!";this._last_header_name="ZRINIT",this._subpacket_encode_func="encode16",this._zencoder=new t.ZDLE,this._consume_ZRINIT(e),this._file_offset=0,this._start_keepalive_on_set_sender=!0}set_sender(e){return super.set_sender(e),this._start_keepalive_on_set_sender&&(this._start_keepalive_on_set_sender=!1,this._start_keepalive()),this}_get_header_formatter(e){return b[e]?"to_binary16":"to_hex"}_start_keepalive(){if(!this._keepalive_promise){var e=this;this._keepalive_promise=new Promise(function(s){e._keepalive_timeout=setTimeout(s,v)}).then(function(){e._next_header_handler={ZACK:function(){e._got_ZSINIT_ZACK=!0}},e._send_ZSINIT(),e._keepalive_promise=null,e._start_keepalive()})}}_stop_keepalive(){this._keepalive_promise&&(clearTimeout(this._keepalive_timeout),this._keep_alive_promise=null)}_send_ZSINIT(){var e=[];this._zencoder.escapes_ctrl_chars()&&e.push("ESCCTL"),this._send_header_and_data(["ZSINIT",e],[0],"end_ack")}_consume_ZRINIT(e){if(this._last_ZRINIT=e,e.get_buffer_size())throw"Buffer size ("+e.get_buffer_size()+") is unsupported!";if(!e.can_full_duplex())throw"Half-duplex I/O is unsupported!";if(!e.can_overlap_io())throw"Non-overlap I/O is unsupported!";if(e.escape_8th_bit())throw"8-bit escaping is unsupported!";this._zencoder.set_escape_ctrl_chars(!0),e.escape_ctrl_chars()||console.debug("Peer didn’t request escape of all control characters. Will send ZSINIT to force recognition of escaped control characters.")}_ensure_receiver_escapes_ctrl_chars(){var e,s=!this._last_ZRINIT.escape_ctrl_chars()&&!this._got_ZSINIT_ZACK;if(s){var o=this;e=new Promise(function(p){o._next_header_handler={ZACK:R=>{p()}},o._send_ZSINIT()})}else e=Promise.resolve();return e}_convert_params_to_offer_payload_array(e){e=t.Validation.offer_parameters(e);var s=e.name+"\0",o=[(e.size||0).toString(10),e.mtime?e.mtime.toString(8):"0",e.mode?(32768|e.mode).toString(8):"0","0"];return e.files_remaining&&(o.push(e.files_remaining),e.bytes_remaining&&o.push(e.bytes_remaining)),s+=o.join(" "),this._string_to_octets(s)}send_offer(e){if(t.DEBUG&&console.debug("SENDING OFFER",e),!e)throw"need file params!";if(this._sending_file)throw"Already sending file!";var s=this._convert_params_to_offer_payload_array(e);this._stop_keepalive();var o=this;function p(){o._next_header_handler={ZRPOS:function(T){t.DEBUG&&console.warn("Mid-transfer ZRPOS … implementation error?"),p()}}}var R=function(){var T=new Promise(function(S){o._next_header_handler={ZSKIP:function(){o._start_keepalive(),S()},ZRPOS:function(D){o._sending_file=!0,p(),S(new l(e,D.get_offset(),o._send_interim_file_piece.bind(o),o._end_file.bind(o)))}}});return o._send_header_and_data(["ZFILE"],s,"end_ack"),delete o._sent_ZDATA,T};return this._ensure_receiver_escapes_ctrl_chars().then(R)}_send_header_and_data(e,s,o){var p=this._create_header_bytes(e),R=this._build_subpacket_bytes(s,o);p[0].push.apply(p[0],R),t.DEBUG&&(this._log_header("SENDING HEADER",p[1]),console.debug(this.type,"-- HEADER PAYLOAD:",o,R.length)),this._sender(p[0]),this._last_sent_header=p[1]}_build_subpacket_bytes(e,s){var o=t.Subpacket.build(e,s);return o[this._subpacket_encode_func](this._zencoder)}_build_and_send_subpacket(e,s){this._sender(this._build_subpacket_bytes(e,s))}_string_to_octets(e){this._textencoder||(this._textencoder=new t.Text.Encoder);var s=this._textencoder.encode(e);return Array.prototype.slice.call(s)}_send_interim_file_piece(e){return this._send_file_part(e,"no_end_no_ack"),Promise.resolve()}_ensure_we_are_sending(){if(!this._sending_file)throw"Not sending a file currently!"}_end_file(e){this._ensure_we_are_sending(),this._send_file_part(e,"end_no_ack");var s=this,o=new Promise(function(p){s._sending_file=!1,s._prepare_to_receive_ZRINIT(p)});return this._send_header("ZEOF",this._file_offset),this._file_offset=0,o}_prepare_to_receive_ZRINIT(e){this._next_header_handler={ZRINIT:function(s){this._consume_ZRINIT(s),e&&e()}}}close(){var e=this._last_header_name==="ZRINIT";if(e||(e=this._last_header_name==="ZSKIP"),e||(e=this._last_sent_header.name==="ZSINIT"&&this._last_header_name==="ZACK"),!e)throw"Can’t close; last received header was “"+this._last_header_name+"”";var s=this,o=new Promise(function(p,R){s._next_header_handler={ZFIN:function(){s._sender(n),s._sent_OO=!0,s._on_session_end(),p()}}});return this._send_header("ZFIN"),o}_has_ended(){return this.aborted()||!!this._sent_OO}_send_file_part(e,s){this._sent_ZDATA||(this._send_header("ZDATA",this._file_offset),this._sent_ZDATA=!0);for(var o=0,p=e.length;;){var R=Math.min(o+_,p)-o,T=R+o>=p,S=e.slice(o,o+R);if(S instanceof Array||(S=Array.prototype.slice.call(S)),this._build_and_send_subpacket(S,T?s:"no_end_no_ack"),this._file_offset+=R,o+=R,o>=p)break}}_consume_first(){if(!this._parse_and_consume_header()&&this._input_buffer.join()==="67")throw"Receiver has fallen back to YMODEM."}_on_session_end(){this._stop_keepalive(),super._on_session_end()}},Object.assign(t.Session.Send.prototype,{type:"send"})})(te);var Ze=te.exports;(function(y){var t=y.exports;Object.assign(t,P,Ze);const v=21,f=[42,42,24,66,48],m=["to_terminal","on_detect","on_retract","sender"];class _{constructor(n,a,h,E){this._confirmer=a,this._denier=h,this._is_valid=E,this._session_type=n}confirm(){return this._confirmer.apply(this,arguments)}deny(){return this._denier.apply(this,arguments)}is_valid(){return this._is_valid.apply(this,arguments)}get_session_role(){return this._session_type}}t.Sentry=class{constructor(n){if(!n)throw"Need options!";var a=this;m.forEach(function(h){if(!n[h])throw"Need “"+h+"”!";a["_"+h]=n[h]}),this._cache=[]}_after_session_end(){this._zsession=null}consume(n){if(n instanceof Array||(n=Array.prototype.slice.call(new Uint8Array(n))),this._zsession){var a=this._zsession;if(a.consume(n),a.has_ended())a.type==="receive"?n=a.get_trailing_bytes():n=[];else return}var h=this._parse(n),E=n;if(h){let b=function(){return x._parsed_session===h},A=function(){if(!this.is_valid())throw"Stale ZMODEM session!";return h.on("garbage",x._to_terminal),h.on("session_end",x._after_session_end.bind(x)),h.set_sender(x._sender),delete x._parsed_session,x._zsession=h};!!this._parsed_session&&(this._parsed_session.type===h.type&&(E=[]),this._on_retract()),this._parsed_session=h;var x=this;this._on_detect(new _(h.type,A,this._send_abort.bind(this),b))}else{var l=this._parsed_session;this._parsed_session=null,l&&(E.length===1&&E[0]===67&&this._send_abort(),this._on_retract())}this._to_terminal(E)}get_confirmed_session(){return this._zsession||null}_send_abort(){this._sender(t.ZMLIB.ABORT_SEQUENCE)}_parse(n){var a=this._cache;for(a.push.apply(a,n);;){let h=t.ZMLIB.find_subarray(a,f);if(h===-1)break;a.splice(0,h);let E;try{E=t.Session.parse(a)}catch{}if(!E)break;return a.length===1&&a[0]===t.ZMLIB.XON&&a.shift(),a.length?null:E}return a.splice(v),null}}})($);var ye=$.exports;(function(y){Object.assign(y.exports,ye)})(J);var le=J.exports;const Ie=Ee(le),Ce=ve({__proto__:null,default:Ie},[le]);export{Ce as i};
