name: Build Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.os }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - os: windows
            arch: amd64
            runner: windows-latest
          # macOS Apple Silicon
          - os: darwin
            arch: arm64
            runner: macos-latest
          # macOS Intel
          - os: darwin
            arch: amd64
            runner: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Wails CLI
        shell: bash
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install frontend dependencies
        shell: bash
        run: |
          cd frontend && npm install

      - name: Build ${{ matrix.os }} ${{ matrix.arch }}
        shell: bash
        run: |
          VERSION="-ldflags=-X main.Version=${{ github.ref_name }}"
          wails build -platform ${{ matrix.os }}/${{ matrix.arch }} -clean $VERSION

      - name: Package macOS
        if: matrix.os == 'darwin'
        shell: bash
        run: |
          cd build/bin

          # Remove quarantine attributes
          xattr -cr AHaSSHTools.app

          # Ad-hoc sign the app
          codesign --force --deep --sign - AHaSSHTools.app || echo "codesign failed, continuing..."

          # Create zip archive
          zip -r AHaSSHTools-macos-${{ matrix.arch }}.zip AHaSSHTools.app

      - name: Upload artifact - ${{ matrix.os }} ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: AHaSSHTools-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            build/bin/*.exe
            build/bin/*.zip
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          files: |
            artifacts/AHaSSHTools-windows-amd64/*.exe
            artifacts/AHaSSHTools-darwin-arm64/*.zip
            artifacts/AHaSSHTools-darwin-amd64/*.zip
          body: |
            
            # 更新说明：
            - 版本号：${{ github.ref_name }}
            - 更新时间：${{ github.event.release.published_at }}
            - 更新内容：
              - 新增功能：
                  - 2026年02月06日16:42:50 目录跟随功能，历史打开文件夹记录，支持在设置中开启/关闭
                  - 2026年02月06日16:47:33 文件夹搜索功能，目前使用为黄色文件夹按钮
              - 修复问题：
                  - 2026年02月09日19:46:16 修复了退出按钮的功能
              - 优化体验：
                  - 2026年02月06日16:47:07 目录跳转按钮紫色放大镜多余，去除
                  - 2026年02月09日19:45:40 关于里面的版本号和tag版本号一致
            
            ## AHaSSHTools ${{ github.ref_name }}

            ### 下载说明

            **Windows**:
            - 下载 `AHaSSHTools.exe`
            - 直接运行即可

            **macOS (Apple Silicon / M1/M2/M3)**:
            - 下载 `AHaSSHTools-macos-arm64.zip`
            - 解压后运行以下命令移除隔离属性：
              ```bash
              xattr -cr AHaSSHTools.app
              open AHaSSHTools.app
              ```

            **macOS (Intel)**:
            - 下载 `AHaSSHTools-macos-amd64.zip`
            - 解压后运行以下命令移除隔离属性：
              ```bash
              xattr -cr AHaSSHTools.app
              open AHaSSHTools.app
              ```
            
            更多信息请访问 [项目主页](https://github.com/${{ github.repository }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
